{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>äº‹æ•…è©³æƒ… - å‡ºè­¦æ±ºç­–</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- header -->
{% include 'includes/header.html' %}

<div class="container-fluid">
    <div class="row">
        <!-- å·¦å´ Sidebar -->
        <div class="col-md-2 p-0">
        {% include 'includes/sidebar.html' %}
        </div>

        <!-- å³å´ä¸»å…§å®¹ -->
        <main class="col-md-10 p-4">

            <h2 class="mb-4">ğŸš¨ äº‹æ•…è©³æƒ…èˆ‡å‡ºè­¦æ±ºç­–</h2>

            <div class="row">
                <!-- å·¦å´ï¼šå½±åƒå€ -->
                <div class="col-md-8">
                <div class="mb-4">
                    <h5>é—œéµç•«é¢ (Key Frame)</h5>
                    <img src="{{ accident.key_frame }}" alt="Key Frame" class="img-fluid rounded border">
                </div>

                <div class="mb-4">
                    <h5>äº‹æ•…å½±åƒé è¦½</h5>
                    {% include 'includes/video_preview_partial.html' with video_folder=accident.video_frame_folder %}
                </div>
                </div>

                <!-- å³å´ï¼šè³‡è¨Šèˆ‡æ“ä½œ -->
                <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-warning">äº‹æ•…è³‡è¨Š</div>
                    <div class="card-body">
                    <p><strong>åœ°é»ï¼š</strong>{{ accident.location }}</p>
                    <p><strong>æ¨¡å‹åµæ¸¬æ™‚é–“ï¼š</strong>{{ accident.detected_time|date:"Y-m-d H:i:s" }}</p>
                    <p><strong>æ¨¡å‹ä¿¡å¿ƒå€¼ï¼š</strong>{{ accident.confidence|floatformat:2 }}</p>
                    <p><strong>ä¾†æºï¼š</strong>{% if accident.is_verified %}äººå·¥ç¢ºèª{% else %}AI åˆåˆ¤{% endif %}</p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-info text-white">äººå·¥ç¢ºèªèˆ‡å‡ºè­¦</div>
                    <div class="card-body">
                        <form id="verify-form" data-url="{% url 'accident_verify' accident.id %}">
                            {% csrf_token %}
                            <div id="form-errors" class="text-danger mt-2"></div>

                            {% if not accident.is_verified %}
                              <!-- å¯ç·¨è¼¯æ¨¡å¼ -->
                              <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="is_verified" id="is_verified"
                                       {% if accident.is_verified %}checked{% endif %}>
                                <label class="form-check-label" for="is_verified">äººå·¥ç¢ºèªæ­¤äº‹æ•…</label>
                              </div>

                              <div class="mb-3">
                                <label for="officer" class="form-label">å‡ºè­¦è­¦å“¡</label>
                                <select class="form-select" id="officer" name="dispatched_police">
                                  <option value="">-- è«‹é¸æ“‡ --</option>
                                  {% for po in police_officers %}
                                    <option value="{{ po.id }}" {% if po.id == accident.dispatched_police.id %}selected{% endif %}>
                                      {{ po.badge_number }} - {{ po.user.get_full_name|default:po.user.username }}
                                    </option>
                                  {% endfor %}
                                </select>
                              </div>

                              <div class="mb-3">
                                <label for="dispatched_time" class="form-label">å‡ºè­¦æ™‚é–“</label>
                                <input type="datetime-local" class="form-control" id="dispatched_time" name="dispatched_time"
                                       value="{{ accident.dispatched_time|date:'Y-m-d\\TH:i' }}">
                              </div>

                              <button type="submit" class="btn btn-danger w-100">âœ… ç¢ºèªå‡ºè­¦</button>

                            {% else %}
                              <!-- é–å®šæ¨¡å¼ï¼šåªé¡¯ç¤ºå€¼ -->
                              <p><strong>å·²ç¢ºèªï¼š</strong>âœ…</p>
                              <p><strong>å‡ºè­¦è­¦å“¡ï¼š</strong>{{ accident.dispatched_police }}</p>
                              <p><strong>å‡ºè­¦æ™‚é–“ï¼š</strong>{{ accident.dispatched_time|date:"Y-m-d H:i" }}</p>
                            {% endif %}
                          </form>

                          <!-- å ±å‘ŠæŒ‰éˆ• -->
                          <div class="mt-3">
                            <button id="generate-report-btn" class="btn btn-outline-primary w-100" data-url="{% url 'accident_report_generate' accident.id %}">
                              ğŸ“ ç”Ÿæˆå ±å‘Šåˆç¨¿
                            </button>
                            <div id="report-message" class="text-info mt-2"></div>
                          </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(function () {
    // ç¢ºèªå‡ºè­¦è¡¨å–® AJAX
    $('#verify-form').on('submit', function (e) {
    e.preventDefault();
    const url = $(this).data('url');
    const formData = $(this).serialize();
    const $errorsDiv = $('#form-errors');

    $.post({
        url: url,
        data: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function () {
        $errorsDiv.html('');
        alert('âœ… è³‡æ–™å·²å„²å­˜');
        location.reload();
        },
        error: function (xhr) {
        $errorsDiv.html('');
        $.each(xhr.responseJSON.errors, function (field, messages) {
            messages.forEach(function (msg) {
            $errorsDiv.append(`<div>${field}: ${msg}</div>`);
            });
        });
        }
    });
    });

    // ç”Ÿæˆå ±å‘Š AJAX
    $('#generate-report-btn').on('click', function () {
    const url = $(this).data('url');
    const $msg = $('#report-message');

    $msg.text('ğŸš§ æ­£åœ¨ç”Ÿæˆå ±å‘Š...');
    $.post({
        url: url,
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
        success: function (res) {
        $msg.text('âœ… å ±å‘Šå·²ç”Ÿæˆ');
        },
        error: function () {
        $msg.text('âŒ ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    });
    });
});
</script>

</body>
</html>
